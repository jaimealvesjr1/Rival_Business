{% extends "base.html" %}

{% block content %}
    <h1 class="mt-4"><i class="fas fa-map-marked-alt me-2"></i>Mapa de Viagem</h1>
    <p class="lead">Conheça as regiões disponíveis e planeje o seu próximo destino.</p>

    {% set NIVEL_MINIMO = 2 %}
    
    {% if jogador.nivel < NIVEL_MINIMO and not viagem_ativa %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-1"></i> Você precisa alcançar o <strong>Nível {{ NIVEL_MINIMO }}</strong> para iniciar viagens entre regiões.
        </div>
    {% endif %}
    
    {# --- TELA DE STATUS DE VIAGEM (Se estiver em viagem) --- #}
    {% if viagem_ativa %}
        <div class="alert alert-warning">
            <h4 class="alert-heading"><i class="fas fa-route me-1"></i> Você está em Viagem!</h4>
            {% set origem = regiao_atual.nome %}
            {% set destino = viagem_ativa.destino.nome %}
            
            <p class="mb-1"><strong>Rota:</strong> {{ origem }} <i class="fas fa-arrow-right"></i> {{ destino }}</p>
            <p id="travel-countdown" data-seconds="{{ tempo_restante_segundos }}">
                <i class="fas fa-clock me-1"></i> Tempo Restante: Calculando...
            </p>
            <p class="small mb-0">Sua região atual será atualizada automaticamente.</p>
        </div>
    {% else %}
        {# --- TELA DE SELEÇÃO DE DESTINO (Se NÃO estiver em viagem) --- #}
        <div class="alert alert-info">
            <i class="fas fa-map-marker-alt me-1"></i> Você está em: <strong>{{ regiao_atual.nome }}</strong>. 
            Aceleração de Viagem: <strong class="text-primary">{{ (regiao_atual.indice_desenvolvimento)|round(0) }}%</strong>.
        </div>
    {% endif %}

    <div class="row">
        {% for opcao in opcoes_viagem %}
            {% set destino = opcao.regiao %}
            {% set is_current = destino.id == regiao_atual.id %}
            
            <div class="col-md-6 mb-4">
                <div class="card h-100 {% if is_current %}border-success{% elif viagem_ativa %}border-secondary{% elif not opcao.pode_viajar and not is_current %}border-danger{% endif %}">
                    
                    <div class="card-header {% if is_current %}bg-success text-white{% elif viagem_ativa %}bg-secondary{% else %}{% endif %}">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-city me-2"></i> {{ destino.nome }}
                            {% if is_current %}<span class="badge bg-light text-dark ms-2">Localização Atual</span>{% endif %}
                        </h5>
                    </div>
                    
                    <div class="card-body">
                        
                        {# --- STATUS DA REGIÃO --- #}
                        <div class="row small text-center">
                            <div class="col-md-6">
                                <strong class="text-primary">Desenvolvimento:</strong><br>{{ "%.1f"|format(destino.indice_desenvolvimento) }} / 10
                            </div>
                            <div class="col-md-6">
                                <strong class="text-secondary">Saúde:</strong><br>{{ "%.0f"|format(destino.indice_saude * 10) }} / 10
                            </div>
                            <div class="col-md-6">
                                <strong class="text-info">Educação:</strong><br>{{ "%.0f"|format(destino.indice_educacao * 10) }} / 10
                            </div>
                            <div class="col-md-6">
                                <strong class="text-danger">Tributação:</strong><br>{{ (destino.taxa_imposto_geral * 100)|round(0) }}%
                            </div>
                        </div>
                        <hr class="my-3">
                        
                        {# --- INFORMAÇÕES E FORMULÁRIO DE VIAGEM --- #}
                        {% if not viagem_ativa and not is_current %}
                            
                            <table class="table table-sm table-borderless small mb-3">
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-road me-1"></i> Distância:</td>
                                        <td>{{ "%.0f"|format(opcao.distancia_bruta) }} Km</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-clock me-1"></i> Tempo Estimado:</td>
                                        <td><strong>{{ opcao.tempo_horas }}h</strong></td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-coins me-1"></i> Custo de Passagem:</td>
                                        <td><strong>{{ opcao.custo_total | currency_format('R$', '.') }}</strong> 
                                            {% if jogador.dinheiro >= opcao.custo_total %}✅{% else %}<span class="text-danger">❌</span>{% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-level-up-alt me-1"></i> Nível Mínimo:</td>
                                        <td><strong>Nv. {{ NIVEL_MINIMO }}</strong> 
                                            {% if jogador.nivel >= NIVEL_MINIMO %}✅{% else %}<span class="text-danger">❌</span>{% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <form method="POST" action="{{ url_for('game_actions.travel') }}">
                                <input type="hidden" name="destino_id" value="{{ destino.id }}">
                                <button type="submit" 
                                        class="btn w-100 btn-sm {% if opcao.pode_viajar and jogador.nivel >= NIVEL_MINIMO %}btn-primary{% else %}btn-danger{% endif %}"
                                        {% if not opcao.pode_viajar or jogador.nivel < NIVEL_MINIMO %}disabled{% endif %}>
                                    {% if jogador.nivel < NIVEL_MINIMO %}
                                        <i class="fas fa-lock me-1"></i> Requer Nv. {{ NIVEL_MINIMO }}
                                    {% elif opcao.pode_viajar %}
                                        <i class="fas fa-ticket-alt me-1"></i> Comprar Passagem e Viajar
                                    {% else %}
                                        <i class="fas fa-frown-open me-1"></i> Renda Insuficiente
                                    {% endif %}
                                </button>
                            </form>

                        {% elif viagem_ativa %}
                            <button class="btn w-100 btn-sm btn-secondary" disabled>
                                <i class="fas fa-clock me-1"></i> Já em Viagem...
                            </button>

                        {% elif is_current %}
                            {# Se for a Região Atual: Botão desabilitado #}
                            <button class="btn w-100 btn-sm btn-success" disabled>
                                <i class="fas fa-map-marker-alt me-1"></i> Você Está Aqui
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            {# Se a lista de regiões estiver vazia #}
            <div class="col-12"><p>Nenhuma região disponível no jogo.</p></div>
        {% endfor %}
    </div>
{% endblock %}
