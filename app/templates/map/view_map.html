{% extends "base.html" %}

{% block content %}
    <h1 class="mt-4">Mapa de Minas Gerais</h1>
    <p class="lead">Conheça as regiões disponíveis e viaje por onde desejar.</p>

    {% set NIVEL_MINIMO = 2 %}
    
    {% if jogador.nivel < NIVEL_MINIMO and not viagem_ativa %}
        <div class="alert alert-danger">
            ⚠️ Você precisa alcançar o <strong>Nível {{ NIVEL_MINIMO }}</strong> para iniciar viagens entre regiões.
        </div>
    {% endif %}
    
    {# --- TELA DE STATUS DE VIAGEM (Se estiver em viagem) --- #}
    {% if viagem_ativa %}
        <div class="alert alert-warning">
            <h4 class="alert-heading">Você está em Viagem!</h4>
            {% set origem = regiao_atual.nome %}
            {% set destino = viagem_ativa.destino.nome %}
            
            <p><strong>Rota:</strong> {{ origem }} <i class="fas fa-arrow-right"></i> {{ destino }}</p>
            <p id="travel-countdown" data-seconds="{{ tempo_restante_segundos }}">
                Tempo Restante: Calculando...
            </p>
            <p class="small">Sua região atual será atualizada automaticamente.</p>
        </div>
    {% else %}
        {# --- TELA DE SELEÇÃO DE DESTINO (Se NÃO estiver em viagem) --- #}
        <div class="alert alert-info">
            Você está em: <strong>{{ regiao_atual.nome }}</strong>. Índice de Desenvolvimento: {{ "%.1f"|format(regiao_atual.indice_desenvolvimento) }} (Aceleração de Viagem: {{ (regiao_atual.indice_desenvolvimento)|round(0) }}%).
        </div>
    {% endif %}

    <div class="row">
        {% for opcao in opcoes_viagem %}
            {% set destino = opcao.regiao %}
            {% set is_current = destino.id == regiao_atual.id %}
            
            <div class="col-md-12 mb-4">
                <div class="card h-100 {% if is_current %}border-success{% elif viagem_ativa %}border-secondary{% elif not opcao.pode_viajar %}border-danger{% endif %}">
                    <div class="card-body">
                        <div>
                            <h5 class="card-title">
                                {{ destino.nome }}
                                {% if is_current %}<span class="badge bg-success ms-2">Sua Localização</span>{% endif %}
                                {% if not viagem_ativa and not is_current %}
                                    - {{ "%.0f"|format(opcao.distancia_bruta) }} Km de viagem
                                {% endif %}
                            </h5>
                        </div>
                        <hr class="my-2">
                        <div class="row small">
                            <div class="col-md-3">
                                <strong class="text-primary">Índice de Desenvolvimento:</strong><br>{{ "%.0f"|format(destino.indice_desenvolvimento) }} / 10
                            </div>
                            <div class="col-md-3">
                                <strong class="text-secondary">Índice de Saúde:</strong><br>{{ "%.0f"|format(destino.indice_saude * 10) }} / 10
                            </div>
                            <div class="col-md-3">
                                <strong class="text-info">Índice de Educação:</strong><br>{{ "%.0f"|format(destino.indice_educacao * 10) }} / 10
                            </div>
                            <div class="col-md-3">
                                <strong class="text-danger">Tributação na Localização:</strong><br>{{ (destino.taxa_imposto_geral * 100)|round(0) }}%
                            </div>
                        </div>
                        <hr class="my-2">
                        {% if not viagem_ativa and not is_current %}
                        <div class="row">
                            <div class="col-md-4 mb-4">
                                <strong>Tempo de Viagem:</strong> {{ opcao.tempo_horas }}h
                            </div>
                            <div class="col-md-4 mb-4">
                                <strong>Custo:</strong> {{ opcao.custo_total | currency_format('R$', '.') }} {% if jogador.dinheiro >= opcao.custo_total %}✅{% else %}❌{% endif %}
                            </div>
                            <div class="col-md-4 mb-4">
                                <strong>Nível Mínimo: {{ NIVEL_MINIMO }}</strong> {% if jogador.nivel >= NIVEL_MINIMO %}✅{% else %}❌{% endif %}
                            </div>
                        </div>
                            <form method="POST" action="{{ url_for('game_actions.travel') }}">
                                <input type="hidden" name="destino_id" value="{{ destino.id }}">
                                <button type="submit" 
                                        class="btn btn-sm {% if opcao.pode_viajar %}btn-success{% elif jogador.nivel < NIVEL_MINIMO %}btn-outline-warning{% else %}btn-outline-danger{% endif %}"
                                        {% if not opcao.pode_viajar or jogador.nivel < NIVEL_MINIMO %}disabled{% endif %}>
                                    {% if jogador.nivel < NIVEL_MINIMO %}
                                        Requer Nv. {{ NIVEL_MINIMO }}
                                    {% elif opcao.pode_viajar %}
                                        Comprar passagem e embarcar
                                    {% else %}
                                        Renda Insuficiente
                                    {% endif %}
                                </button>
                            </form>

                        {% elif viagem_ativa %}
                            <button class="btn btn-sm btn-secondary" disabled>
                                Já em Viagem...
                            </button>

                        {% elif is_current %}
                            {# Se for a Região Atual: Botão desabilitado #}
                            <button class="btn btn-sm btn-success" disabled>
                                Você Está Aqui
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            {# Se a lista de regiões estiver vazia #}
            <div class="col-12"><p>Nenhuma região disponível no jogo.</p></div>
        {% endfor %}
    </div>
{% endblock %}
